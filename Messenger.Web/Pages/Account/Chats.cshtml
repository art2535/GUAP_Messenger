@page
@model Messenger.Web.Pages.Account.ChatsModel
@{
    ViewData["Title"] = "Чаты";
    Layout = null;
}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"
        integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .guap-gradient {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    }

    .chat-item:hover {
        background-color: #f3f4f6;
    }

    .chat-item.active {
        background-color: #e5e7eb;
    }

    #chats-list {
        max-height: calc(100vh - 200px);
    }

    .attachment {
        color: #3b82f6;
        text-decoration: underline;
    }

    /* Модальные окна */
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transition: opacity .3s ease, visibility .3s ease;
    }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

    /* Контекстное меню */
    #context-menu {
        position: absolute;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,.1);
        z-index: 100;
        min-width: 140px;
        display: none;
    }

        #context-menu button {
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            border: none;
            background: none;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
        }

            #context-menu button:hover {
                background: #f3f4f6;
            }

            #context-menu button.danger:hover {
                background: #fef2f2;
                color: #dc2626;
            }
</style>

<div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="guap-gradient text-white w-10 h-10 rounded-full flex items-center justify-center">
                    <i data-feather="message-square" class="w-5 h-5"></i>
                </div>
                <h1 class="font-bold text-lg">GUAP Messenger</h1>
            </div>
            <a asp-page="/Account/Settings" class="text-gray-500 hover:text-gray-700"><i data-feather="settings" class="w-5 h-5"></i></a>
        </div>

        <div class="p-3 border-b border-gray-200 space-y-2">
            <div class="relative">
                <input type="text" id="chat-search" placeholder="Поиск по чатам"
                       class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white">
                <i data-feather="search" class="absolute left-3 top-2.5 text-gray-400 w-5 h-5"></i>
            </div>
            <button id="create-chat-btn" class="w-full guap-gradient text-white py-2 px-4 rounded-lg hover:opacity-90 transition flex items-center justify-center">
                <i data-feather="plus" class="w-4 h-4 mr-2"></i> Создать чат
            </button>
        </div>

        <div class="flex-1 overflow-y-auto" id="chats-list">
            <div class="text-gray-500 p-4">Загрузка чатов...</div>
        </div>

        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center space-x-3">
                <img src="http://static.photos/people/200x200/4" alt="User" class="w-10 h-10 rounded-full">
                <div>
                    <p class="font-medium">@Model.UserName</p>
                    <p class="text-xs text-gray-500">@Model.UserRole</p>
                </div>
                <form asp-page="/Authorization/Logout" method="post" class="ml-auto">
                    <button type="submit" class="text-gray-500 hover:text-red-600"><i data-feather="log-out" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat area -->
    <div class="flex-1 flex flex-col">
        <div id="chat-header" class="p-4 border-b border-gray-200 flex items-center justify-between bg-white">
            <div class="flex items-center space-x-3">
                <div>
                    <h2 id="chat-title" class="font-medium">Выберите чат</h2>
                    <p id="chat-subtitle" class="text-xs text-gray-500">Нет активного чата</p>
                </div>
            </div>
        </div>
        <div id="messages-container" class="flex-1 p-4 overflow-y-auto bg-gray-50">
            <div id="no-chat-selected" class="flex items-center justify-center h-full text-gray-500">
                <p>Выберите чат для просмотра сообщений</p>
            </div>
        </div>
        <div class="p-3 border-t border-gray-200 bg-white">
            <div class="flex items-center space-x-2">
                <label for="file-input" class="cursor-pointer text-gray-500 hover:text-gray-700"><i data-feather="paperclip" class="w-5 h-5"></i></label>
                <input id="file-input" type="file" class="hidden" multiple>
                <input id="message-input" type="text" placeholder="Напишите сообщение..."
                       class="flex-1 px-4 py-2 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white">
                <button id="send-button" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="send" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="attached-files" class="text-sm text-gray-600 mt-2"></div>
        </div>
    </div>
</div>

<!-- Контекстное меню -->
<div id="context-menu">
    <button id="ctx-edit">Изменить</button>
    <button id="ctx-delete" class="danger">Удалить</button>
</div>

<!-- Модальное окно создания -->
<div id="create-chat-modal" class="modal">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6 transform transition-all duration-300 scale-95" id="create-modal-content">
        <h2 class="text-lg font-medium mb-4">Создать новый чат</h2>
        <label class="block mb-2 text-sm font-medium text-gray-700">Название чата</label>
        <input type="text" id="new-chat-name" class="w-full border border-gray-300 rounded-lg p-2 mb-4 focus:ring-2 focus:ring-blue-500">
        <label class="block mb-2 text-sm font-medium text-gray-700">Тип чата</label>
        <select id="new-chat-type" class="w-full border border-gray-300 rounded-lg p-2 mb-6 focus:ring-2 focus:ring-blue-500">
            <option value="private">Приватный</option>
            <option value="group">Групповой</option>
        </select>
        <div class="flex justify-end space-x-2">
            <button id="cancel-create-chat" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Отмена</button>
            <button id="submit-create-chat" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Создать</button>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования -->
<div id="edit-chat-modal" class="modal">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6 transform transition-all duration-300 scale-95" id="edit-modal-content">
        <h2 class="text-lg font-medium mb-4">Редактировать чат</h2>
        <label class="block mb-2 text-sm font-medium text-gray-700">Название чата</label>
        <input type="text" id="edit-chat-name" class="w-full border border-gray-300 rounded-lg p-2 mb-4 focus:ring-2 focus:ring-blue-500">
        <label class="block mb-2 text-sm font-medium text-gray-700">Тип чата</label>
        <select id="edit-chat-type" class="w-full border border-gray-300 rounded-lg p-2 mb-6 focus:ring-2 focus:ring-blue-500">
            <option value="private">Приватный</option>
            <option value="group">Групповой</option>
        </select>
        <div class="flex justify-end space-x-2">
            <button id="cancel-edit-chat" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Отмена</button>
            <button id="submit-edit-chat" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Сохранить</button>
        </div>
    </div>
</div>

<script>
    feather.replace();

    // === Элементы ===
    const chatsList = document.getElementById('chats-list');
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const fileInput = document.getElementById('file-input');
    const attachedFiles = document.getElementById('attached-files');
    const createChatBtn = document.getElementById('create-chat-btn');
    const createChatModal = document.getElementById('create-chat-modal');
    const editChatModal = document.getElementById('edit-chat-modal');
    const contextMenu = document.getElementById('context-menu');
    const ctxEdit = document.getElementById('ctx-edit');
    const ctxDelete = document.getElementById('ctx-delete');

    let currentChatId = null;
    let contextChatId = null;
    let selectedFiles = [];
    let connection = null;

    const token = '@(HttpContext.Session.GetString("JWT_SECRET") ?? "")';
    const API_BASE = 'https://localhost:7045/api';
    const HUB_URL = 'https://localhost:7045/hubs/chat';

    if (!token) {
        chatsList.innerHTML = '<div class="p-4 text-red-500">Ошибка: токен не найден. Перезайдите.</div>';
    }

    // === SignalR ===
    async function startSignalR() {
        connection = new signalR.HubConnectionBuilder()
            .withUrl(HUB_URL, {
                accessTokenFactory: () => token,
                transport: signalR.HttpTransportType.WebSockets
            })
            .withAutomaticReconnect([0, 2000, 10000])
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.on('ReceiveMessage', (message) => {
            if (message.chatId !== currentChatId) return;
            appendMessage(message);
            scrollToBottom();
        });

        connection.on('MessageStatusUpdated', (status) => {
            const msgEl = document.querySelector(`[data-message-id="${status.messageId}"]`);
            if (!msgEl) return;
            const statusEl = msgEl.querySelector('.status');
            if (statusEl) {
                statusEl.textContent = status.status === 'Delivered' ? 'Доставлено' : 'Прочитано';
                statusEl.className = `status ${status.status.toLowerCase()}`;
            }
        });

        connection.on('ReactionAdded', (reaction) => {
            const msgEl = document.querySelector(`[data-message-id="${reaction.messageId}"]`);
            if (!msgEl) return;
            let reactionsEl = msgEl.querySelector('.reactions');
            if (!reactionsEl) {
                reactionsEl = document.createElement('div');
                reactionsEl.className = 'reactions text-xs mt-1';
                msgEl.appendChild(reactionsEl);
            }
            reactionsEl.innerHTML += `<span class="mr-1 bg-gray-200 rounded px-1">${reaction.reactionType}</span>`;
        });

        connection.onreconnecting(() => {
            connectionStatus.textContent = 'Переподключение...';
            connectionStatus.className = 'text-orange-500';
            sendButton.disabled = true;
        });

        connection.onreconnected(() => {
            connectionStatus.textContent = 'Онлайн';
            connectionStatus.className = 'text-green-500';
            sendButton.disabled = false;
            if (currentChatId) joinChat(currentChatId);
        });

        try {
            await connection.start();
            console.log('SignalR: Подключено');
            connectionStatus.textContent = 'Онлайн';
            connectionStatus.className = 'text-green-500';
            sendButton.disabled = false;
        } catch (err) {
            console.error('SignalR: Ошибка', err);
            connectionStatus.textContent = 'Ошибка';
            connectionStatus.className = 'text-red-500';
            setTimeout(startSignalR, 5000);
        }
    }

    async function joinChat(chatId) {
        if (!connection || connection.state !== signalR.HubConnectionState.Connected) return;
        try {
            await connection.invoke('JoinChat', chatId);
        } catch (err) { console.error('JoinChat error:', err); }
    }

    async function leaveChat(chatId) {
        if (!connection || connection.state !== signalR.HubConnectionState.Connected) return;
        try {
            await connection.invoke('LeaveChat', chatId);
        } catch (err) { console.error('LeaveChat error:', err); }
    }

    // === Загрузка чатов ===
    async function loadChats() {
        try {
            const res = await fetch(`${API_BASE}/chats`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const result = await res.json();
            if (!result.isSuccess || !result.data?.length) {
                chatsList.innerHTML = '<div class="p-4 text-gray-500">Чатов нет</div>';
                return;
            }
            chatsList.innerHTML = '';
            result.data.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'p-4 chat-item flex items-center space-x-3 cursor-pointer relative';
                const chatId = chat.chatId || chat.id || chat.ChatId;
                if (!chatId) return;
                div.dataset.chatId = String(chatId);
                div.dataset.chatType = chat.type || 'private';
                div.innerHTML = `
                    <div class="relative">
                        <img src="${chat.avatar || 'http://static.photos/people/200x200/default'}"
                             alt="Avatar" class="w-12 h-12 rounded-full object-cover">
                        <span class="absolute bottom-0 right-0 w-3 h-3 ${chat.isOnline ? 'bg-green-500' : 'bg-gray-300'} rounded-full border-2 border-white"></span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <h3 class="font-medium truncate">${chat.name || 'Без имени'}</h3>
                            <span class="text-xs text-gray-500">${chat.lastMessageTime || ''}</span>
                        </div>
                        <p class="text-sm text-gray-500 truncate">${chat.lastMessage || ''}</p>
                    </div>
                `;
                chatsList.appendChild(div);
            });
        } catch (error) {
            chatsList.innerHTML = `<div class="p-4 text-red-500">Ошибка: ${error.message}</div>`;
        }
    }

    // === Выбор чата ===
    chatsList.addEventListener('click', async e => {
        const chatItem = e.target.closest('.chat-item');
        if (!chatItem) return;
        const newChatId = chatItem.dataset.chatId;
        if (currentChatId === newChatId) return;

        if (currentChatId) await leaveChat(currentChatId);
        currentChatId = newChatId;

        document.querySelectorAll('.chat-item').forEach(c => c.classList.remove('active'));
        chatItem.classList.add('active');

        await loadMessages(currentChatId);
        await joinChat(currentChatId);
    });

    // === Загрузка сообщений ===
    async function loadMessages(chatId) {
        messagesContainer.innerHTML = '<p class="text-center text-gray-500">Загрузка...</p>';
        try {
            const res = await fetch(`${API_BASE}/messages/${chatId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const result = await res.json();
            if (!result.isSuccess) throw new Error(result.error);
            messagesContainer.innerHTML = '';
            (result.data || []).forEach(msg => appendMessage(msg));
            scrollToBottom();
        } catch (error) {
            messagesContainer.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
        }
    }

    // === Добавление сообщения ===
    function appendMessage(msg) {
        const isMine = msg.senderId === '@Model.UserId';
        const messageEl = document.createElement('div');
        messageEl.className = `mb-3 ${isMine ? 'text-right' : 'text-left'}`;
        messageEl.dataset.messageId = msg.messageId;

        messageEl.innerHTML = `
            <div class="inline-block max-w-xs px-4 py-2 rounded-lg shadow-sm ${isMine ? 'bg-blue-500 text-white' : 'bg-white'}">
                ${msg.messageText || ''}
                <div class="status ${isMine ? 'text-blue-200' : 'text-gray-500'}">
                    ${msg.status === 'Read' ? 'Прочитано' : msg.status === 'Delivered' ? 'Доставлено' : 'Отправлено'}
                </div>
            </div>
            <div class="reactions"></div>
        `;

        messagesContainer.appendChild(messageEl);
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // === Отправка сообщения через SignalR ===
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text && !selectedFiles.length) return;
        if (!currentChatId) return alert('Выберите чат');

        try {
            await connection.invoke('SendMessage', currentChatId, null, text, selectedFiles.length > 0);
            messageInput.value = '';
            selectedFiles = [];
            attachedFiles.innerHTML = '';
        } catch (err) {
            console.error('SendMessage error:', err);
            alert('Не удалось отправить сообщение');
        }
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    fileInput.addEventListener('change', () => {
        selectedFiles = Array.from(fileInput.files);
        attachedFiles.innerHTML = selectedFiles.map(f => `<span class="attachment mr-2">${f.name}</span>`).join('');
    });

    // === Контекстное меню ===
    chatsList.addEventListener('contextmenu', e => {
        const chatItem = e.target.closest('.chat-item');
        if (!chatItem) return;
        e.preventDefault();
        contextChatId = chatItem.dataset.chatId;
        contextMenu.style.display = 'block';
        contextMenu.style.left = `${e.pageX}px`;
        contextMenu.style.top = `${e.pageY}px`;
    });
    document.addEventListener('click', () => contextMenu.style.display = 'none');

    ctxEdit.addEventListener('click', () => {
        contextMenu.style.display = 'none';
        const chatItem = [...chatsList.children].find(c => c.dataset.chatId === contextChatId);
        if (!chatItem) return;
        document.getElementById('edit-chat-name').value = chatItem.querySelector('h3').textContent;
        document.getElementById('edit-chat-type').value = chatItem.dataset.chatType;
        editChatModal.classList.add('show');
        document.getElementById('edit-modal-content').classList.remove('scale-95').add('scale-100');
    });

    ctxDelete.addEventListener('click', async () => {
        contextMenu.style.display = 'none';
        if (!confirm('Удалить чат? Это нельзя отменить.')) return;
        try {
            const res = await fetch(`${API_BASE}/chats/${contextChatId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const result = await res.json();
            if (!result.isSuccess) throw new Error(result.error);
            await loadChats();
            if (currentChatId === contextChatId) {
                currentChatId = null;
                messagesContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><p>Выберите чат</p></div>';
            }
        } catch (error) {
            alert('Ошибка удаления: ' + error.message);
        }
    });

    document.getElementById('submit-edit-chat').addEventListener('click', async () => {
        const name = document.getElementById('edit-chat-name').value.trim();
        const type = document.getElementById('edit-chat-type').value;
        if (!name) return alert('Введите название');
        try {
            const res = await fetch(`${API_BASE}/chats/${contextChatId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, type })
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const result = await res.json();
            if (!result.isSuccess) throw new Error(result.error);
            closeEditModal();
            await loadChats();
        } catch (error) {
            alert('Ошибка: ' + error.message);
        }
    });

    // === Модальные окна ===
    function closeModal(modal, contentId) {
        modal.classList.remove('show');
        document.getElementById(contentId).classList.remove('scale-100').add('scale-95');
    }
    document.getElementById('cancel-create-chat').addEventListener('click', () => closeModal(createChatModal, 'create-modal-content'));
    createChatModal.addEventListener('click', e => { if (e.target === createChatModal) closeModal(createChatModal, 'create-modal-content'); });
    document.getElementById('cancel-edit-chat').addEventListener('click', () => closeModal(editChatModal, 'edit-modal-content'));
    editChatModal.addEventListener('click', e => { if (e.target === editChatModal) closeModal(editChatModal, 'edit-modal-content'); });

    createChatBtn.addEventListener('click', () => {
        createChatModal.classList.add('show');
        document.getElementById('create-modal-content').classList.remove('scale-95').add('scale-100');
        document.getElementById('new-chat-name').focus();
    });

    document.getElementById('submit-create-chat').addEventListener('click', async () => {
        const name = document.getElementById('new-chat-name').value.trim();
        const type = document.getElementById('new-chat-type').value;
        if (!name) return alert('Введите название');
        document.getElementById('submit-create-chat').disabled = true;
        document.getElementById('submit-create-chat').textContent = 'Создание...';
        try {
            const res = await fetch(`${API_BASE}/chats/create-chat`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ Name: name, Type: type })
            });
            const text = await res.text();
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
            const result = JSON.parse(text);
            if (!result.isSuccess) throw new Error(result.error);
            alert('Чат создан!');
            closeModal(createChatModal, 'create-modal-content');
            await loadChats();
        } catch (error) {
            alert('Ошибка: ' + error.message);
        } finally {
            document.getElementById('submit-create-chat').disabled = false;
            document.getElementById('submit-create-chat').textContent = 'Создать';
        }
    });

    function closeEditModal() { closeModal(editChatModal, 'edit-modal-content'); }

    // === Инициализация ===
    loadChats();
    startSignalR();
</script>