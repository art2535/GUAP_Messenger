@page
@using System.Text.Json
@model Messenger.Web.Pages.Account.SettingsModel
@{
    Layout = null;
    var user = Model.CurrentUserJson.ValueKind != JsonValueKind.Undefined
        ? Model.CurrentUserJson
        : JsonDocument.Parse("{}").RootElement;
    var hasAvatar = user.TryGetProperty("avatar", out var av) && !string.IsNullOrEmpty(av.GetString());
    var avatarUrl = hasAvatar ? av.GetString()! : null;
    var lastName = user.TryGetProperty("lastName", out var ln) ? ln.GetString() ?? "" : "";
    var firstName = user.TryGetProperty("firstName", out var fn) ? fn.GetString() ?? "" : "";
    var middleName = user.TryGetProperty("middleName", out var mn) ? mn.GetString() : null;
    var fullName = $"{lastName} {firstName.FirstOrDefault()}." +
                   (!string.IsNullOrEmpty(middleName) ? middleName[0] + "." : "");
}
<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
        }

        body {
            display: flex;
        }

        .guap-gradient {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }

        .input-field {
            transition: all 0.3s;
        }

            .input-field:focus {
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            }

        .sidebar {
            width: 256px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .sidebar-header {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background-color: #f8fafc;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

            .modal-overlay.active {
                opacity: 1;
                pointer-events: all;
            }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 420px;
            transform: translateY(20px);
            transition: transform 0.3s;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body class="flex">
    <!-- Сайдбар -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="guap-gradient text-white w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-feather="message-square" class="w-6 h-6"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">GUAP Messenger</h1>
        </div>

        <nav class="sidebar-menu">
            <a asp-page="/Account/Chats" class="block py-2.5 px-4 text-gray-600 rounded-lg hover:bg-gray-100 transition">
                Чаты
            </a>
            <a href="#" class="block py-2.5 px-4 bg-blue-50 text-blue-600 rounded-lg font-medium">
                Настройки
            </a>
            <div class="pl-6 mt-3 space-y-1">
                <a href="#profile" class="block py-1.5 px-4 text-sm text-gray-600 hover:bg-gray-100 rounded">Профиль</a>
                <a href="#notifications" class="block py-1.5 px-4 text-sm text-gray-600 hover:bg-gray-100 rounded">Уведомления</a>
                <a href="#privacy" class="block py-1.5 px-4 text-sm text-gray-600 hover:bg-gray-100 rounded">Приватность</a>
                <a href="#account" class="block py-1.5 px-4 text-sm text-gray-600 hover:bg-gray-100 rounded">Аккаунт</a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <p class="text-sm text-gray-600 text-center truncate">@fullName</p>
        </div>
    </aside>

    <!-- Основной контент со скроллом -->
    <main class="main-content">
        <h2 class="text-3xl font-bold text-gray-800 mb-8">Настройки</h2>

        <form method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="AvatarUrl" />

            <div class="max-w-4xl mx-auto space-y-8">

                <!-- Профиль -->
                <section id="profile" class="bg-white rounded-xl shadow-md p-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Профиль</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="flex items-center space-x-6">
                            @if (hasAvatar)
                            {
                                <img src="@avatarUrl" alt="Avatar" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 shadow">
                            }
                            else
                            {
                                <div class="guap-gradient text-white w-24 h-24 rounded-full flex items-center justify-center shadow-lg">
                                    <i data-feather="user" class="w-12 h-12"></i>
                                </div>
                            }
                            <div>
                                <input type="file" id="avatarInput" accept="image/*" class="hidden">
                                <label for="avatarInput" class="guap-gradient text-white py-3 px-6 rounded-lg hover:opacity-90 transition font-medium cursor-pointer inline-block">
                                    Изменить фото
                                </label>
                                <p class="text-sm text-gray-500 mt-2">JPG, PNG, GIF · до 2 МБ</p>
                            </div>
                        </div>

                        <div class="space-y-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Фамилия</label>
                                <input asp-for="Profile.LastName" class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Имя</label>
                                <input asp-for="Profile.FirstName" class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Отчество</label>
                                <input asp-for="Profile.MiddleName" class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6 mt-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Логин (email)</label>
                            <input asp-for="Profile.Login" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                            <input asp-for="Profile.Phone" type="tel" class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field">
                        </div>
                    </div>
                </section>

                <!-- Уведомления -->
                <section id="notifications" class="bg-white rounded-xl shadow-md p-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Уведомления</h3>
                    <div class="space-y-6">
                        <label class="flex items-center justify-between cursor-pointer">
                            <div class="flex items-center">
                                <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                <span class="ml-3 text-gray-700 font-medium">Сообщения</span>
                            </div>
                            <p class="text-sm text-gray-500 max-w-md">Получать уведомления о новых личных сообщениях</p>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                            <div class="flex items-center">
                                <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                <span class="ml-3 text-gray-700 font-medium">Групповые чаты</span>
                            </div>
                            <p class="text-sm text-gray-500 max-w-md">Уведомления из групповых чатов и каналов</p>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                            <div class="flex items-center">
                                <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                <span class="ml-3 text-gray-700 font-medium">Объявления</span>
                            </div>
                            <p class="text-sm text-gray-500 max-w-md">Важные сообщения от университета и администрации</p>
                        </label>
                    </div>
                </section>

                <!-- Приватность -->
                <section id="privacy" class="bg-white rounded-xl shadow-md p-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Приватность</h3>
                    <div class="space-y-8">

                        <!-- Показывать профиль / онлайн -->
                        <div class="space-y-6">
                            <label class="flex items-center justify-between cursor-pointer">
                                <div class="flex items-center">
                                    <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="ml-3 text-gray-700 font-medium">Показывать профиль</span>
                                </div>
                                <p class="text-sm text-gray-500">Разрешить другим видеть ваш профиль</p>
                            </label>
                            <label class="flex items-center justify-between cursor-pointer">
                                <div class="flex items-center">
                                    <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="ml-3 text-gray-700 font-medium">Показывать статус онлайн</span>
                                </div>
                                <p class="text-sm text-gray-500">Другие видят, когда вы в сети</p>
                            </label>
                        </div>

                        <!-- Чёрный список -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-800 mb-5">Чёрный список</h4>

                            <!-- Список заблокированных -->
                            <div class="space-y-3 mb-6">
                                @if (Model.BlockedUsers.Any())
                                {
                                    @foreach (var blocked in Model.BlockedUsers)
                                    {
                                        var blockedId = blocked.TryGetProperty("id", out var id) ? id.GetString() ?? "" : "";
                                        var blockedName = blocked.TryGetProperty("name", out var n) ? n.GetString() : "Неизвестно";
                                        var blockedLogin = blocked.TryGetProperty("login", out var l) ? l.GetString() : null;

                                        <div class="flex items-center justify-between p-4 bg-red-50 border border-red-200 rounded-lg">
                                            <div class="flex items-center space-x-4">
                                                <div class="w-12 h-12 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex items-center justify-center">
                                                    <i data-feather="user-x" class="w-6 h-6 text-gray-500"></i>
                                                </div>
                                                <div>
                                                    <p class="font-medium text-gray-800">@blockedName</p>
                                                    @if (!string.IsNullOrEmpty(blockedLogin))
                                                    {
                                                        <p class="text-sm text-gray-500">@blockedLogin</p>
                                                    }
                                                </div>
                                            </div>
                                            <button type="button"
                                                    onclick="unblockUser('@blockedId')"
                                                    class="text-red-600 hover:text-red-800 font-medium text-sm transition">
                                                Разблокировать
                                            </button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-gray-500 italic text-center py-4">Чёрный список пуст</p>
                                }
                            </div>

                            <!-- Поиск пользователя для блокировки -->
                            <div class="relative">
                                <input type="text"
                                       id="user-search-input"
                                       autocomplete="off"
                                       placeholder="Найти пользователя по имени..."
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field focus:border-blue-500">

                                <!-- Выпадающий список результатов -->
                                <div id="search-results"
                                     class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden">
                                </div>
                            </div>

                            <div class="mt-4 text-sm text-gray-500">
                                Начните вводить имя — появится список пользователей
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Кнопки -->
                <div class="flex justify-end gap-4 py-6">
                    <button type="button" onclick="history.back()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                        Отмена
                    </button>
                    <button type="submit" class="px-8 py-3 guap-gradient text-white rounded-lg hover:opacity-90 transition font-medium">
                        Сохранить изменения
                    </button>
                </div>

                <!-- Аккаунт -->
                <section id="account" class="bg-white rounded-xl shadow-md p-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Аккаунт</h3>
                    <div class="space-y-4">
                        <button type="button" onclick="openChangePasswordModal()" class="text-blue-600 hover:underline font-medium">
                            Сменить пароль
                        </button>
                        <br>
                        <button type="button" onclick="openDeleteAccountModal()" class="text-red-600 hover:underline font-medium">
                            Удалить аккаунт
                        </button>
                    </div>
                </section>
            </div>
        </form>
    </main>

    <!-- Модальные окна -->
    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Смена пароля</h3>
                <button onclick="closeChangePasswordModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="changePasswordForm" class="space-y-5">
                <div>
                    <label class="block font-medium mb-2">Текущий пароль</label>
                    <input type="password" id="currentPassword" required class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div>
                    <label class="block font-medium mb-2">Новый пароль</label>
                    <input type="password" id="newPassword" required minlength="6" class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div>
                    <label class="block font-medium mb-2">Подтверждение</label>
                    <input type="password" id="confirmPassword" required minlength="6" class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeChangePasswordModal()" class="px-5 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">Отмена</button>
                    <button type="submit" class="px-6 py-3 guap-gradient text-white rounded-lg hover:opacity-90">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteAccountModal" class="modal-overlay">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-red-600">Удаление аккаунта</h3>
                <button onclick="closeDeleteAccountModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-6">Вы уверены? Это действие нельзя отменить.</p>
            <div class="space-y-5">
                <div><label class="block font-medium mb-2">Пароль для подтверждения</label><input type="password" id="deletePassword" required class="w-full px-4 py-3 border rounded-lg"></div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeDeleteAccountModal()" class="px-5 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">Отмена</button>
                    <button type="button" onclick="confirmDeleteAccount()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">Удалить аккаунт</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        // === Модальные окна ===
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('active');
        }
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }
        function openDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.add('active');
        }
        function closeDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.remove('active');
        }
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', e => {
                if (e.target === m) m.classList.remove('active');
            });
        });

        // === Загрузка аватара ===
        document.getElementById('avatarInput').onchange = async e => {
            const file = e.target.files[0];
            if (!file) return;
            const fd = new FormData();
            fd.append('file', file);
            const r = await fetch('https://localhost:7001/api/upload/avatar', { method: 'POST', body: fd });
            if (r.ok) {
                const j = await r.json();
                const img = document.querySelector('img[alt="Avatar"]');
                if (img) img.src = j.url + '?t=' + Date.now();
                document.querySelector('[asp-for="AvatarUrl"]').value = j.url;
            }
        };

        // === Плавная прокрутка по якорям ===
        document.querySelectorAll('a[href^="#"]').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                const target = document.querySelector(a.getAttribute('href'));
                if (target) {
                    document.querySelector('.main-content').scrollTo({
                        top: target.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // === Получение JWT-токена из сессии через сервер ===
        async function getJwtToken() {
            try {
                const response = await fetch('/Account/Settings?handler=GetToken');
                const result = await response.json();
                return result.token || '';
            } catch {
                return '';
            }
        }

        // === Поиск пользователей ===
        let searchTimeout;
        document.getElementById('user-search-input').addEventListener('input', function () {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            resultsDiv.classList.add('hidden');

            if (query.length < 2) return;

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`?handler=SearchUsers&query=${encodeURIComponent(query)}`);
                    if (!response.ok) throw new Error('Search failed');

                    const users = await response.json();

                    if (users.length === 0) {
                        resultsDiv.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Ничего не найдено</div>';
                        resultsDiv.classList.remove('hidden');
                        return;
                    }

                    users.forEach(user => {
                        const item = document.createElement('div');
                        item.className = 'flex items-center space-x-3 p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0 transition';
                        item.innerHTML = `
                            <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-200">
                                <img src="${user.avatar}" alt="${user.name}" class="w-full h-full object-cover"
                                     onerror="this.src='/images/default-avatar.png'">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-gray-800 truncate">${user.name}</p>
                            </div>
                        `;
                        item.onclick = () => {
                            document.getElementById('user-search-input').value = '';
                            resultsDiv.classList.add('hidden');
                            blockUserById(user.id, user.name);
                        };
                        resultsDiv.appendChild(item);
                    });

                    resultsDiv.classList.remove('hidden');
                } catch (err) {
                    console.error('Ошибка поиска:', err);
                    resultsDiv.innerHTML = '<div class="p-4 text-center text-red-500 text-sm">Ошибка загрузки</div>';
                    resultsDiv.classList.remove('hidden');
                }
            }, 300);
        });

        // === Блокировка пользователя по GUID ===
        async function blockUserById(userId, userName) {
            if (!confirm(`Заблокировать пользователя "${userName}"?`)) return;

            const token = await getJwtToken();
            if (!token) {
                alert('Сессия истекла. Перезайдите в аккаунт.');
                return;
            }

            try {
                const response = await fetch(`https://localhost:7001/api/users/block/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert(`Пользователь "${userName}" заблокирован`);
                    location.reload();
                } else if (response.status === 401) {
                    alert('Токен недействителен. Перезайдите в аккаунт.');
                } else {
                    const error = await response.text();
                    alert('Ошибка блокировки: ' + error);
                }
            } catch (err) {
                console.error(err);
                alert('Не удалось выполнить запрос');
            }
        }

        // === Разблокировка пользователя по GUID ===
        async function unblockUser(userId) {
            if (!confirm('Разблокировать этого пользователя?')) return;

            const token = await getJwtToken();
            if (!token) {
                alert('Сессия истекла. Перезайдите в аккаунт.');
                return;
            }

            try {
                const response = await fetch(`https://localhost:7001/api/users/unblock/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('Пользователь разблокирован');
                    location.reload();
                } else {
                    alert('Ошибка разблокировки');
                }
            } catch (err) {
                console.error(err);
                alert('Не удалось выполнить запрос');
            }
        }

        // === Скрывать выпадающий список при клике вне ===
        document.addEventListener('click', e => {
            const searchInput = document.getElementById('user-search-input');
            const searchResults = document.getElementById('search-results');
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        // === Очистка поля поиска при фокусе (опционально) ===
        document.getElementById('user-search-input').addEventListener('focus', function () {
            if (this.value.trim()) {
                document.getElementById('search-results').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>