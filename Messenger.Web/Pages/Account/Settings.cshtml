@page
@using System.Text.Json
@using System.Text.Encodings.Web
@model Messenger.Web.Pages.Account.SettingsModel
@{
    Layout = null;

    var hasAvatar = Model.HasAvatar;
    var avatarUrl = Model.AvatarUrl;

    var lastName = Model.Profile.LastName;
    var firstName = Model.Profile.FirstName;
    var middleName = Model.Profile.MiddleName;

    var fullName = $"{lastName} {firstName.FirstOrDefault()}." +
                   (!string.IsNullOrEmpty(middleName) ? middleName[0].ToString() + "." : "");
}

<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
        }

        body {
            display: flex;
        }

        .guap-gradient {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: white;
            transition: all 0.3s;
        }

            .input-field:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            }

        .sidebar {
            width: 256px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background-color: #f8fafc;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

            .modal-overlay.active {
                opacity: 1;
                pointer-events: all;
            }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 420px;
            transform: translateY(20px);
            transition: transform 0.3s;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            min-width: 320px;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            color: white;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.4s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

            .toast.show {
                transform: translateX(0);
            }

            .toast.success {
                background: linear-gradient(135deg, #16a34a, #22c55e);
            }

            .toast.error {
                background: linear-gradient(135deg, #dc2626, #ef4444);
            }

            .toast.info {
                background: linear-gradient(135deg, #1e40af, #3b82f6);
            }
    </style>
</head>
<body class="flex">
    <aside class="sidebar">
        <div class="p-6 text-center border-b border-gray-200">
            <div class="guap-gradient w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-feather="message-square" class="w-6 h-6 text-white"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">GUAP Messenger</h1>
        </div>
        <nav class="flex-1 p-4">
            <a asp-page="/Account/Chats" class="block py-2.5 px-4 text-gray-600 rounded-lg hover:bg-gray-100 transition">Чаты</a>
            <a href="#" class="block py-2.5 px-4 bg-blue-50 text-blue-600 rounded-lg font-medium">Настройки</a>
            <div class="pl-6 mt-3 space-y-1">
                <a href="#profile" class="block py-1.5 px-4 text-sm text-gray-600 hover:bg-gray-100 rounded">Профиль</a>
                <a href="#notifications" class="block py-1.5 px-4 text-sm text-gray-600 hover:bg-gray-100 rounded">Уведомления</a>
                <a href="#privacy" class="block py-1.5 px-4 text-sm text-gray-600 hover:bg-gray-100 rounded">Приватность</a>
                <a href="#account" class="block py-1.5 px-4 text-sm text-gray-600 hover:bg-gray-100 rounded">Аккаунт</a>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-200 text-center">
            <p class="text-sm text-gray-600 truncate">@fullName</p>
        </div>
    </aside>

    <main class="main-content">
        @if (TempData["SuccessMessage"] != null)
        {
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    showToast('@TempData["SuccessMessage"]', 'success');
                });
            </script>
        }
        <h2 class="text-3xl font-bold text-gray-800 mb-8">Настройки</h2>

        <form method="post" enctype="multipart/form-data" asp-page-handler="Save" class="max-w-4xl mx-auto space-y-8">
            <section id="profile" class="bg-white rounded-xl shadow-md p-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-8">Профиль</h3>

                <div class="flex flex-col md:flex-row gap-10 items-start">
                    <div class="flex flex-col items-center space-y-4">
                        <div class="relative">
                            @if (hasAvatar && !string.IsNullOrEmpty(avatarUrl))
                            {
                                <img id="current-avatar"
                                     src="@avatarUrl?t=@DateTime.Now.Ticks"
                                     alt="Аватар"
                                     class="w-40 h-40 rounded-full object-cover border-4 border-gray-200 shadow-xl"
                                     onerror="document.getElementById('default-avatar').style.display='flex';">
                            }
                            else
                            {
                                <div id="current-avatar" class="guap-gradient w-40 h-40 rounded-full flex items-center justify-center shadow-xl">
                                    <i data-feather="user" class="w-20 h-20 text-white"></i>
                                </div>
                            }

                            <div id="default-avatar"
                                 class="guap-gradient w-40 h-40 rounded-full flex items-center justify-center shadow-xl absolute inset-0 @(hasAvatar && !string.IsNullOrEmpty(avatarUrl) ? "hidden" : "flex")">
                                <i data-feather="user" class="w-20 h-20 text-white"></i>
                            </div>

                            <div id="avatar-preview-container" class="hidden absolute inset-0 rounded-full overflow-hidden border-4 border-blue-600 shadow-2xl z-20 pointer-events-none">
                                <img id="avatar-preview" src="" alt="Preview" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-blue-600 bg-opacity-30 flex items-center justify-center">
                                    <span class="text-white font-bold text-xl">Предпросмотр</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col space-y-3 w-full max-w-xs">
                            <input type="file" id="avatarInput" name="AvatarFile" accept="image/*" class="hidden">
                            <label for="avatarInput" class="guap-gradient text-white py-3 px-8 rounded-lg hover:opacity-90 cursor-pointer font-medium text-center transition">
                                Изменить фото
                            </label>
                            <p class="text-sm text-gray-500 text-center">JPG, PNG, GIF, WEBP · до 2 МБ</p>

                            <button type="button" id="cancel-preview" class="text-sm text-gray-600 hover:underline hidden">
                                Отменить выбор
                            </button>

                            <button type="button" id="delete-avatar-trigger"
                                    class="text-sm text-red-600 hover:text-red-800 hover:underline @(hasAvatar ? "" : "hidden")">
                                Удалить фото
                            </button>
                        </div>

                        <input type="hidden" name="DeleteAvatar" id="delete-avatar-flag" value="false" />
                    </div>

                    <div class="flex-1 space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Фамилия</label>
                                <input asp-for="Profile.LastName" class="input-field" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Имя</label>
                                <input asp-for="Profile.FirstName" class="input-field" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Отчество</label>
                            <input asp-for="Profile.MiddleName" class="input-field">
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Логин (email)</label>
                                <input asp-for="Profile.Login" type="email" class="input-field" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                                <input asp-for="Profile.Phone" type="tel" class="input-field">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="notifications" class="bg-white rounded-xl shadow-md p-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Уведомления</h3>
                <div class="space-y-5">
                    <label class="flex items-center justify-between cursor-pointer">
                        <div class="flex items-center">
                            <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded">
                            <span class="ml-3 font-medium">Сообщения</span>
                        </div>
                    </label>
                    <label class="flex items-center justify-between cursor-pointer">
                        <div class="flex items-center">
                            <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded">
                            <span class="ml-3 font-medium">Групповые чаты</span>
                        </div>
                    </label>
                    <label class="flex items-center justify-between cursor-pointer">
                        <div class="flex items-center">
                            <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded">
                            <span class="ml-3 font-medium">Объявления</span>
                        </div>
                    </label>
                </div>
            </section>

            <section id="privacy" class="bg-white rounded-xl shadow-md p-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Приватность</h3>
                <div class="space-y-8">
                    <div class="space-y-5">
                        <label class="flex items-center justify-between cursor-pointer">
                            <div class="flex items-center">
                                <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded">
                                <span class="ml-3 font-medium">Показывать профиль</span>
                            </div>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                            <div class="flex items-center">
                                <input type="checkbox" checked class="h-5 w-5 text-blue-600 rounded">
                                <span class="ml-3 font-medium">Показывать статус онлайн</span>
                            </div>
                        </label>
                    </div>

                    <div>
                        <h4 class="text-lg font-medium text-gray-800 mb-5">Чёрный список</h4>

                        <div id="blocked-users-list" class="space-y-3 mb-6">
                            @if (Model.BlockedUsers.Any())
                            {
                                foreach (var blocked in Model.BlockedUsers)
                                {
                                    var id = blocked.TryGetProperty("id", out var i) ? i.GetString() ?? "" : "";
                                    var name = blocked.TryGetProperty("name", out var n) ? n.GetString() ?? "Неизвестно" : "Неизвестно";
                                    var login = blocked.TryGetProperty("login", out var l) ? l.GetString() : null;

                                    <div class="blocked-user-item flex items-center justify-between p-4 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition"
                                         data-user-id="@id">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 rounded-full bg-gray-200 border-2 border-dashed flex items-center justify-center">
                                                <i data-feather="user-x" class="w-6 h-6 text-gray-500"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-800">@name</p>
                                                @if (!string.IsNullOrEmpty(login))
                                                {
                                                    <p class="text-sm text-gray-500">@login</p>
                                                }
                                            </div>
                                        </div>
                                        <button type="button"
                                                class="unblock-btn text-red-600 hover:text-red-800 font-medium text-sm"
                                                data-id="@id"
                                                data-name="@HtmlEncoder.Default.Encode(name)">
                                            Разблокировать
                                        </button>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-gray-500 italic text-center py-8">Чёрный список пуст</p>
                            }
                        </div>

                        <div class="relative">
                            <input type="text" id="user-search-input" autocomplete="off" placeholder="Поиск по имени..."
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                            <div id="search-results" class="absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden"></div>
                        </div>
                        <p class="mt-3 text-sm text-gray-500">Начните вводить имя — появятся пользователи</p>
                    </div>
                </div>
            </section>

            <div class="flex justify-end gap-4 py-8">
                <button type="button" onclick="history.back()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">Отмена</button>
                <button type="submit" class="px-8 py-3 guap-gradient text-white rounded-lg hover:opacity-90 font-medium">Сохранить изменения</button>
            </div>

            <section id="account" class="bg-white rounded-xl shadow-md p-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Аккаунт</h3>
                <div class="space-y-4">
                    <button type="button" onclick="openChangePasswordModal()" class="text-blue-600 hover:underline font-medium">Сменить пароль</button><br>
                    <button type="button" onclick="openDeleteAccountModal()" class="text-red-600 hover:underline font-medium">Удалить аккаунт</button>
                </div>
            </section>
        </form>
    </main>

    <div id="toast-container"></div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content p-8 text-center">
            <h3 class="text-xl font-semibold mb-4" id="confirmTitle">Подтвердите действие</h3>
            <p class="text-gray-600 mb-8" id="confirmMessage"></p>
            <div class="flex justify-center gap-4">
                <button onclick="closeConfirm(false)" class="px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">Отмена</button>
                <button id="confirmYesBtn" class="px-6 py-3 guap-gradient text-white rounded-lg hover:opacity-90">Подтвердить</button>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Смена пароля</h3>
                <button onclick="closeChangePasswordModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="changePasswordForm" class="space-y-5">
                <div>
                    <label class="block font-medium mb-2">Текущий пароль</label>
                    <input type="password" id="currentPassword" required class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div>
                    <label class="block font-medium mb-2">Новый пароль</label>
                    <input type="password" id="newPassword" required minlength="6" class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div>
                    <label class="block font-medium mb-2">Подтвердите новый пароль</label>
                    <input type="password" id="confirmPassword" required minlength="6" class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeChangePasswordModal()" class="px-5 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">Отмена</button>
                    <button type="submit" class="px-6 py-3 guap-gradient text-white rounded-lg hover:opacity-90">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteAccountModal" class="modal-overlay">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-red-600">Удаление аккаунта</h3>
                <button onclick="closeDeleteAccountModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-6">Вы уверены? Это действие нельзя отменить.</p>
            <div class="space-y-5">
                <div>
                    <label class="block font-medium mb-2">Введите пароль для подтверждения</label>
                    <input type="password" id="deletePassword" required class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeDeleteAccountModal()" class="px-5 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">Отмена</button>
                    <button type="button" onclick="deleteAccount()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">Удалить аккаунт</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        let connection = null;

        async function initSignalR() {
            const token = await getJwtToken();
            if (!token) return;

            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7001/hubs/chat", { accessTokenFactory: () => token })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on("UserBlocked", (blockedUserId) => {
                fetchUserAndAddToBlocked(blockedUserId);
            });

            connection.on("UserUnblocked", (unblockedUserId) => {
                removeFromBlockedList(unblockedUserId);
                showToast("Вы разблокировали пользователя", "success");
            });

            connection.on("UserBlockedMe", async (blockerId) => {
                await fetchUserAndAddToBlocked(blockerId);
                showToast("Вы были заблокированы пользователем", "info");
            });

            connection.on("UserUnblockedMe", (unblockerId) => {
                removeFromBlockedList(unblockerId);
                showToast("Вы были разблокированы", "success");
            });

            connection.on("ProfileUpdated", (data) => {
                const currentUserId = '@Model.CurrentUserJson.TryGetProperty("userId", out var uid) ? uid.GetString() : ""';
                if (data.userId === currentUserId) {
                    updateAvatarDisplay(data.avatarUrl);
                    hasOriginalAvatar = !!data.avatarUrl;
                    deleteAvatarTrigger.classList.toggle('hidden', !hasOriginalAvatar);
                }
            });

            connection.start()
                .then(() => console.log("SignalR подключён"))
                .catch(err => console.error("SignalR ошибка:", err));
        }

        function updateAvatarDisplay(avatarUrl) {
            if (avatarUrl) {
                currentAvatar.src = avatarUrl + '?t=' + new Date().getTime();
                currentAvatar.style.display = 'block';
                if (currentAvatar.tagName === 'DIV') {
                    const img = document.createElement('img');
                    img.id = 'current-avatar';
                    img.src = avatarUrl + '?t=' + new Date().getTime();
                    img.alt = 'Avatar';
                    img.className = 'w-28 h-28 rounded-full object-cover border-4 border-gray-200 shadow-lg';
                    currentAvatar.parentNode.replaceChild(img, currentAvatar);
                    currentAvatar = img;
                }
            } else {
                if (currentAvatar.tagName === 'IMG') {
                    currentAvatar.src = '/images/default-avatar.png?t=' + new Date().getTime();
                }
            }
        }

        function showToast(message, type = 'info', duration = 4000) {
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'fixed top-4 right-4 z-50 flex flex-col gap-3';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            toast.className = 'px-6 py-4 rounded-xl shadow-2xl text-white font-medium min-w-80 max-w-sm transform translate-x-full opacity-0 transition-all duration-500 ease-out flex items-center gap-3';

            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-orange-600'
            };
            toast.classList.add(colors[type] || 'bg-blue-600');

            toast.innerHTML = `
                <div class="flex-1">${message}</div>
                <button class="ml-4 text-white/70 hover:text-white">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            `;

            toastContainer.insertBefore(toast, toastContainer.firstChild);

            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            const timeoutId = setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
                toast.style.opacity = '0';
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);

            toast.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                clearTimeout(timeoutId);
                toast.style.transform = 'translateX(120%)';
                toast.style.opacity = '0';
                toast.addEventListener('transitionend', () => toast.remove());
            });

            feather.replace();
        }

        async function fetchUserAndAddToBlocked(userId) {
            if (document.querySelector(`[ data-user-id="${userId}"]`)) {
                return;
            }

            const token = await getJwtToken();
            if (!token) {
                addToBlockedList(userId, "Пользователь", "");
                return;
            }

            try {
                const res = await fetch(`https://localhost:7001/api/users/${userId}/name`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let name = "Пользователь";
                if (res.ok) {
                    const data = await res.json();
                    name = (data.data || "").trim() || "Пользователь";
                }

                addToBlockedList(userId, name, "");
            } catch (err) {
                console.error("Ошибка загрузки имени:", err);
                addToBlockedList(userId, "Пользователь", "");
            }
        }

        function removeFromBlockedList(userId) {
            const item = document.querySelector(`.blocked-user-item[data-user-id="${userId}"]`);
            if (item) {
                item.remove();
                if (!document.querySelector('.blocked-user-item')) {
                    document.getElementById('blocked-users-list').innerHTML =
                        '<p class="text-gray-500 italic text-center py-8">Чёрный список пуст</p>';
                }
            }
        }

        let confirmCallback = null;
        function openConfirm(title, message) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('active');
            return new Promise(resolve => confirmCallback = resolve);
        }
        function closeConfirm(result = false) {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmCallback) {
                confirmCallback(result);
                confirmCallback = null;
            }
        }
        
        document.getElementById('confirmYesBtn').onclick = () => closeConfirm(true);

        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', e => {
                if (e.target === m) {
                    m.classList.remove('active');
                    if (m.id === 'confirmModal') closeConfirm(false);
                }
            });
        });

        function openChangePasswordModal() { document.getElementById('changePasswordModal').classList.add('active'); }
        function closeChangePasswordModal() { document.getElementById('changePasswordModal').classList.remove('active'); }

        function openDeleteAccountModal() { document.getElementById('deleteAccountModal').classList.add('active'); }
        function closeDeleteAccountModal() { document.getElementById('deleteAccountModal').classList.remove('active'); }

        document.getElementById('changePasswordForm').onsubmit = async e => {
            e.preventDefault();
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (newPass !== confirmPass) {
                showToast('Пароли не совпадают', 'error');
                return;
            }

            const token = await getJwtToken();
            if (!token) { showToast('Сессия истекла', 'error'); return; }

            try {
                const res = await fetch('/Account/Settings?handler=ChangePassword', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value },
                    body: JSON.stringify({ currentPassword: current, newPassword: newPass })
                });

                if (res.ok) {
                    showToast('Пароль успешно изменён', 'success');
                    closeChangePasswordModal();
                    document.getElementById('changePasswordForm').reset();
                } else {
                    const err = await res.text();
                    showToast(err || 'Ошибка смены пароля', 'error');
                }
            } catch {
                showToast('Ошибка соединения', 'error');
            }
        };

        async function deleteAccount() {
            const password = document.getElementById('deletePassword').value;
            if (!password.length === 0) {
                showToast('Введите пароль', 'error');
                return;
            }

            const token = await getJwtToken();
            if (!token) { showToast('Сессия истекла', 'error'); return; }

            try {
                const res = await fetch('/Account/Settings?handler=DeleteAccount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value },
                    body: JSON.stringify({ password })
                });

                if (res.ok) {
                    showToast('Аккаунт удалён. Перенаправление...', 'info');
                    setTimeout(() => window.location.href = '/Account/Login', 2000);
                } else {
                    const err = await res.text();
                    showToast(err || 'Неверный пароль', 'error');
                }
            } catch {
                showToast('Ошибка соединения', 'error');
            }
        }

        let searchTimer;
        document.getElementById('user-search-input').addEventListener('input', function () {
            clearTimeout(searchTimer);
            const query = this.value.trim();
            const results = document.getElementById('search-results');
            results.innerHTML = '';
            results.classList.add('hidden');

            if (query.length < 2) return;

            searchTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`?handler=SearchUsers&query=${encodeURIComponent(query)}`);
                    const users = await res.json();

                    if (users.length === 0) {
                        results.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Ничего не найдено</div>';
                        results.classList.remove('hidden');
                        return;
                    }

                    users.forEach(user => {
                        const item = document.createElement('div');
                        item.className = 'flex items-center space-x-3 p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0';
                        item.innerHTML = `
                            <img src="${user.avatar || '/images/default-avatar.png'}" class="w-10 h-10 rounded-full object-cover" onerror="this.src='/images/default-avatar.png'">
                            <div><p class="font-medium">${user.name}</p></div>
                        `;
                        item.onclick = () => {
                            this.value = '';
                            results.classList.add('hidden');
                            confirmBlock(user.id, user.name, user.login || '');
                        };
                        results.appendChild(item);
                    });
                    results.classList.remove('hidden');
                } catch {
                    showToast('Ошибка поиска', 'error');
                }
            }, 300);
        });

        async function confirmBlock(userId, userName, userLogin = '') {
            const ok = await openConfirm('Блокировка', `Заблокировать пользователя «${userName}»?`);
            if (!ok) return;

            const token = await getJwtToken();
            if (!token) {
                showToast('Сессия истекла', 'error');
                return;
            }

            try {
                const res = await fetch(`https://localhost:7001/api/users/block/${userId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    showToast(`«${userName}» добавлен в чёрный список`, 'success');
                } else if (res.status === 409) {
                    showToast('Уже в чёрном списке', 'info');
                } else {
                    const err = await res.text();
                    showToast(err || 'Ошибка блокировки', 'error');
                }
            } catch (err) {
                showToast('Ошибка сети', 'error');
            }
        }

        function decodeHtml(html) {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        }


        window.addEventListener('load', async () => {
            feather.replace();

            const blockedList = document.getElementById('blocked-users-list');
            if (blockedList) {
                blockedList.addEventListener('click', async (e) => {
                    const btn = e.target.closest('.unblock-btn');
                    if (!btn) return;

                    const userId = btn.dataset.id;
                    const userName = decodeHtml(btn.dataset.name);

                    const ok = await openConfirm('Разблокировка', `Разблокировать пользователя «${userName}»?`);
                    if (!ok) return;

                    const token = await getJwtToken();
                    if (!token) return showToast('Сессия истекла', 'error');

                    try {
                        const res = await fetch(`https://localhost:7001/api/users/unblock/${userId}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (res.ok) {
                            showToast(`«${userName}» разблокирован`, 'success');
                            btn.closest('.blocked-user-item').remove();

                            if (!document.querySelector('.blocked-user-item')) {
                                blockedList.innerHTML = '<p class="text-gray-500 italic text-center py-8">Чёрный список пуст</p>';
                            }
                        } else {
                            showToast('Ошибка разблокировки', 'error');
                        }
                    } catch {
                        showToast('Ошибка сети', 'error');
                    }
                });
            }

            await initSignalR();
        });

        function addToBlockedList(userId, name, login = '') {
            if (document.querySelector(`[ data-user-id="${userId}"]`)) {
                return;
            }

            const list = document.getElementById('blocked-users-list');

            const emptyMsg = list.querySelector('p');
            if (emptyMsg) emptyMsg.remove();

            if (document.querySelector(`[data-user-id="${userId}"]`)) return;

            const item = document.createElement('div');
            item.className = 'blocked-user-item flex items-center justify-between p-4 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition';
            item.dataset.userId = userId;

            const encodedName = name
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');

            item.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-full bg-gray-200 border-2 border-dashed flex items-center justify-center">
                        <i data-feather="user-x" class="w-6 h-6 text-gray-500"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-800">${name}</p>
                        ${login ? `<p class="text-sm text-gray-500">${login}</p>` : ''}
                    </div>
                </div>
                <button type="button" class="unblock-btn text-red-600 hover:text-red-800 font-medium text-sm"
                        data-id="${userId}"
                        data-name="${encodedName}">
                    Разблокировать
                </button>
            `;

            list.appendChild(item);
            feather.replace();
        }

        document.addEventListener('click', e => {
            const input = document.getElementById('user-search-input');
            const results = document.getElementById('search-results');
            if (!input.contains(e.target) && !results.contains(e.target)) {
                results.classList.add('hidden');
            }
        });

        document.querySelectorAll('a[href^="#"]').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                const target = document.querySelector(a.getAttribute('href'));
                if (target) {
                    document.querySelector('.main-content').scrollTo({ top: target.offsetTop - 100, behavior: 'smooth' });
                }
            });
        });

        document.getElementById('changePasswordForm').onsubmit = async function(e) {
            e.preventDefault();

            const oldPass = document.getElementById('currentPassword').value.trim();
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (!oldPass) return showToast('Введите текущий пароль', 'error');
            if (newPass !== confirmPass) return showToast('Пароли не совпадают', 'error');
            if (newPass.length < 6) return showToast('Новый пароль должен быть не менее 6 символов', 'error');

            const token = await getJwtToken();
            if (!token) return showToast('Сессия истекла. Войдите заново.', 'error');

            try {
                const response = await fetch('https://localhost:7001/api/users/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldPassword: oldPass,
                        newPassword: newPass
                    })
                });

                if (response.ok) {
                    showToast('Пароль успешно изменён!', 'success');
                    closeChangePasswordModal();
                    this.reset();
                } else {
                    const error = await response.text();
                    showToast(error || 'Не удалось сменить пароль', 'error');
                }
            } catch (err) {
                showToast('Ошибка соединения с сервером', 'error');
            }
        };

        async function deleteAccount() {
            const password = document.getElementById('deletePassword').value.trim();

            if (!password) {
                showToast('Введите пароль для подтверждения', 'error');
                return;
            }

            const confirmed = await openConfirm(
                'Удаление аккаунта',
                'Вы уверены? Это действие нельзя отменить. Введите пароль ещё раз.'
            );
            if (!confirmed) return;

            try {
                const token = await getJwtToken();

                const response = await fetch('https://localhost:7001/api/users/delete-account', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showToast('Аккаунт успешно удалён. До свидания!', 'success');
                    setTimeout(() => {
                        window.location.href = '/Authorization/Logout';
                    }, 2500);
                } else {
                    const error = await response.text();
                    showToast(error || 'Неверный пароль или ошибка сервера', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Не удалось подключиться к серверу', 'error');
            }
        }

        async function getJwtToken() {
            try {
                const res = await fetch('/Account/Settings?handler=GetToken');
                const data = await res.json();
                return data.token || '';
            } catch (err) {
                console.error('Failed to get token:', err);
                return '';
            }
        }

        const avatarInput = document.getElementById('avatarInput');
        const currentAvatar = document.getElementById('current-avatar');
        const previewContainer = document.getElementById('avatar-preview-container');
        const previewImg = document.getElementById('avatar-preview');
        const cancelPreviewBtn = document.getElementById('cancel-preview');
        const deleteAvatarTrigger = document.getElementById('delete-avatar-trigger');
        const deleteAvatarFlag = document.getElementById('delete-avatar-flag');
        let hasOriginalAvatar = '@hasAvatar'.toLowerCase() === 'true';

        // Превью
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                hidePreview();
                return;
            }
            if (!file.type.startsWith('image/')) {
                showToast('Выберите изображение', 'error');
                avatarInput.value = '';
                return;
            }
            if (file.size > 2 * 1024 * 1024) {
                showToast('Файл не должен превышать 2 МБ', 'error');
                avatarInput.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = (ev) => {
                previewImg.src = ev.target.result;
                previewContainer.classList.remove('hidden');
                cancelPreviewBtn.classList.remove('hidden');
                deleteAvatarTrigger.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        });

        cancelPreviewBtn.addEventListener('click', () => {
            avatarInput.value = '';
            hidePreview();
        });

        deleteAvatarTrigger.addEventListener('click', () => {
            if (!confirm('Удалить аватар навсегда?')) return;
            deleteAvatarFlag.value = 'true';
            hidePreview();
            updateAvatarDisplay(null);
            showToast('Аватар будет удалён после сохранения', 'info');
        });

        function hidePreview() {
            previewContainer.classList.add('hidden');
            cancelPreviewBtn.classList.add('hidden');
            if (hasOriginalAvatar) {
                deleteAvatarTrigger.classList.remove('hidden');
            }
        }

        window.addEventListener('load', async () => {
            feather.replace();
            await initSignalR();
        });
    </script>
</body>
</html>